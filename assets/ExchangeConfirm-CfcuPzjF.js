import{n as T,E as D,m as O,K as Q,c as W,k as X,I as Y,L as R,y as Z,j as L,M as ee,o as te,w as oe,N as ne,B as se,C as ae}from"./index-I69ywWr9.js";import{E as le}from"./index-DNoe9sOS.js";import"./index-B0rN40JS.js";import{C as ie}from"./index-C-qcxUgF.js";import{C as ce,T as re}from"./index-DUSSjGYZ.js";import{d as ue,j as E,l as q,x as de,c as o,p as A,r as b,y as pe,_ as ve,u as me,g as N,z as fe,e as ge,a as w,w as s,b as l,o as g,f as _,A as U,t as k,h as _e}from"./index-NED_JcNa.js";import{u as ye,s as ke}from"./products-aJkd3TcT.js";import{P as he,m as Ce,u as we,s as z}from"./function-call-BcP60zGU.js";let h=0;function xe(e){e?(h||document.body.classList.add("van-toast--unclickable"),h++):h&&(h--,h||document.body.classList.remove("van-toast--unclickable"))}const[be,y]=W("toast"),Se=["show","overlay","teleport","transition","overlayClass","overlayStyle","closeOnClickOverlay","zIndex"],Pe={icon:String,show:Boolean,type:O("text"),overlay:Boolean,message:T,iconSize:T,duration:Q(2e3),position:O("middle"),teleport:[String,Object],wordBreak:String,className:D,iconPrefix:String,transition:O("van-fade"),loadingType:String,forbidClick:Boolean,overlayClass:D,overlayStyle:Object,closeOnClick:Boolean,closeOnClickOverlay:Boolean,zIndex:T};var F=ue({name:be,props:Pe,emits:["update:show"],setup(e,{emit:i,slots:u}){let a,p=!1;const t=()=>{const c=e.show&&e.forbidClick;p!==c&&(p=c,xe(p))},v=c=>i("update:show",c),f=()=>{e.closeOnClick&&v(!1)},m=()=>clearTimeout(a),S=()=>{const{icon:c,type:r,iconSize:d,iconPrefix:n,loadingType:I}=e;if(c||r==="success"||r==="fail")return o(Y,{name:c||r,size:d,class:y("icon"),classPrefix:n},null);if(r==="loading")return o(R,{class:y("loading"),size:d,type:I},null)},P=()=>{const{type:c,message:r}=e;if(u.message)return o("div",{class:y("text")},[u.message()]);if(Z(r)&&r!=="")return c==="html"?o("div",{key:0,class:y("text"),innerHTML:String(r)},null):o("div",{class:y("text")},[r])};return E(()=>[e.show,e.forbidClick],t),E(()=>[e.show,e.type,e.message,e.duration],()=>{m(),e.show&&e.duration>0&&(a=setTimeout(()=>{v(!1)},e.duration))}),q(t),de(t),()=>o(he,A({class:[y([e.position,e.wordBreak==="normal"?"break-normal":e.wordBreak,{[e.type]:!e.icon}]),e.className],lockScroll:!1,onClick:f,onClosed:m,"onUpdate:show":v},X(e,Se)),{default:()=>[S(),P()]})}});const Ie={icon:"",type:"text",message:"",className:"",overlay:!1,onClose:void 0,onOpened:void 0,duration:2e3,teleport:"body",iconSize:void 0,iconPrefix:void 0,position:"middle",transition:"van-fade",forbidClick:!1,loadingType:void 0,overlayClass:"",overlayStyle:void 0,closeOnClick:!1,closeOnClickOverlay:!1};let x=[],Be=!1,V=L({},Ie);const Te=new Map;function G(e){return te(e)?e:{message:e}}function Oe(){const{instance:e}=Ce({setup(){const i=b(""),{open:u,state:a,close:p,toggle:t}=we(),v=()=>{},f=()=>o(F,A(a,{onClosed:v,"onUpdate:show":t}),null);return E(i,m=>{a.message=m}),pe().render=f,{open:u,close:p,message:i}}});return e}function Ne(){if(!x.length||Be){const e=Oe();x.push(e)}return x[x.length-1]}function ze(e={}){if(!ee)return{};const i=Ne(),u=G(e);return i.open(L({},V,Te.get(u.type||V.type),u)),i}const Ee=e=>i=>ze(L({type:e},G(i))),Le=Ee("success");oe(F);const Me={class:"exchange-confirm"},$e={key:0,class:"loading-state"},je={key:1,class:"content"},De={class:"product-section"},Ue=["src","alt"],Ve={class:"product-title"},Re={class:"product-description"},qe={class:"points-section"},Ae={class:"notice-section"},Fe={class:"exchange-button"},Ge={key:2,class:"error-state"},He={__name:"ExchangeConfirm",setup(e){const i=fe(),u=ge(),a=me(),p=ye(),t=b(null),v=b(!1),f=b(!0),m=N(()=>t.value?(a.userInfo.points||0)-(t.value.points||0):0),S=N(()=>t.value?t.value.stock>0&&(a.userInfo.points||0)>=(t.value.points||0):!1),P=N(()=>t.value?t.value.stock===0?"商品缺貨":(a.userInfo.points||0)<(t.value.points||0)?"點數不足":`確認兌換 (${t.value.points} 點)`:"載入中..."),c=()=>{ke({title:"確認兌換",message:`確定要用 ${t.value.points} 點兌換「${t.value.name}」嗎？`,confirmButtonText:"確認兌換",cancelButtonText:"取消"}).then(()=>{r()}).catch(()=>{})},r=async()=>{v.value=!0;try{await new Promise(n=>setTimeout(n,1e3)),a.deductPoints(t.value.points)?(p.updateProductStock&&p.updateProductStock(t.value.id,t.value.stock-1),a.addExchangeRecord({productName:t.value.name,points:t.value.points,productImage:t.value.image,type:"exchange"}),Le("兌換成功！"),setTimeout(()=>{u.push("/history")},1500)):z({type:"danger",message:"點數不足，兌換失敗"})}catch{z({type:"danger",message:"兌換失敗，請重試"})}finally{v.value=!1}};return q(()=>{const d=i.params.id;console.log("Product ID:",d),setTimeout(()=>{t.value=p.getProductById(d),console.log("Found product:",t.value),f.value=!1,t.value||(z({type:"danger",message:"商品不存在"}),setTimeout(()=>{u.back()},1500))},500)}),(d,n)=>{const I=ne,M=R,B=re,H=ce,C=ae,$=ie,j=se,K=le;return g(),w("div",Me,[o(I,{title:"兌換確認","left-arrow":"",onClickLeft:n[0]||(n[0]=J=>d.$router.back())}),f.value?(g(),w("div",$e,[o(M,{size:"24px",vertical:""},{default:s(()=>n[2]||(n[2]=[_("載入中...")])),_:1,__:[2]})])):t.value?(g(),w("div",je,[l("div",De,[o(H,null,{thumb:s(()=>[l("img",{src:t.value.image,alt:t.value.name,class:"product-thumb"},null,8,Ue)]),title:s(()=>[l("div",Ve,k(t.value.name),1)]),desc:s(()=>[l("div",Re,k(t.value.description),1)]),tags:s(()=>[o(B,{type:"warning"},{default:s(()=>[_(k(t.value.points)+" 點",1)]),_:1}),t.value.stock>0?(g(),U(B,{key:0,type:"success"},{default:s(()=>[_("庫存："+k(t.value.stock),1)]),_:1})):(g(),U(B,{key:1,type:"danger"},{default:s(()=>n[3]||(n[3]=[_("缺貨")])),_:1,__:[3]}))]),_:1})]),l("div",qe,[o($,{title:"點數資訊"},{default:s(()=>[o(C,{title:"目前點數",value:(_e(a).userInfo.points||0).toLocaleString()},null,8,["value"]),o(C,{title:"所需點數",value:(t.value.points||0).toLocaleString()},null,8,["value"]),o(C,{title:"兌換後剩餘",value:m.value.toLocaleString(),"value-class":m.value<0?"negative-points":"positive-points"},null,8,["value","value-class"])]),_:1})]),l("div",Ae,[o($,{title:"兌換須知"},{default:s(()=>[o(C,null,{default:s(()=>n[4]||(n[4]=[l("div",{class:"notice-content"},[l("p",null,"• 兌換後點數將立即扣除，無法退回"),l("p",null,"• 兌換商品將於3-5個工作天內寄送"),l("p",null,"• 如有問題請聯繫客服：0800-123-456"),l("p",null,"• 兌換紀錄可在「兌換紀錄」中查看")],-1)])),_:1,__:[4]})]),_:1})]),l("div",Fe,[o(j,{type:"primary",block:"",size:"large",disabled:!S.value,loading:v.value,onClick:c},{default:s(()=>[_(k(P.value),1)]),_:1},8,["disabled","loading"])])])):(g(),w("div",Ge,[o(K,{description:"商品不存在"}),o(j,{type:"primary",onClick:n[1]||(n[1]=J=>d.$router.push("/products"))},{default:s(()=>n[5]||(n[5]=[_(" 返回商品列表 ")])),_:1,__:[5]})]))])}}},tt=ve(He,[["__scopeId","data-v-998c0206"]]);export{tt as default};
